<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cafe24.seoje1004.subAccount.repository.SubAccountMapper">
	<resultMap type="com.cafe24.seoje1004.subAccount.model.SubAccount" id="subAccountResultMap">
		<id 	property="subAccountCode" 			column="sub_account_code"/>
		<result property="subAccountFlow" 			column="sub_account_flow"/>
		<result property="totalAccountGroup" 		column="total_account_group"/>
		<result property="subAccountTable" 			column="sub_account_table"/>
		<result property="subAccountSum" 			column="sub_account_sum"/>
		<result property="subAccountRequestDate" 	column="sub_account_request_date"/>
		<result property="subAccountCheck" 			column="sub_account_check"/>
		<result property="subAccountDetail" 		column="sub_account_detail"/>
		<result property="subjectCode" 				column="subject_code"/>
		<result property="subClientCode" 			column="sub_client_code"/>
		<result property="subCode" 					column="sub_code"/>
		<result property="subStaffCode" 			column="sub_staff_code"/>
		<result property="subStaffKeeper" 			column="sub_staff_keeper"/>
	</resultMap>
	<!-- 가맹 통합회계 등록 -->
	<insert id="addSubAccount"
		parameterType="com.cafe24.seoje1004.subAccount.model.SubAccount">
		<selectKey resultType="hashmap" keyProperty="subAccountCode" order="BEFORE">
			select if(isnull(sub_account_code),'sub_account_code1000', concat('sub_account_code', MAX(CONVERT(SUBSTRING(sub_account_code,17), UNSIGNED))+1)) as subAccountCode
			from sub_account
		</selectKey>
		
		INSERT INTO sub_account
			(sub_account_code, sub_account_flow, total_account_group, sub_account_table, sub_account_sum, sub_account_request_date, sub_account_detail, subject_code, sub_code, sub_staff_code)
		VALUES (#{subAccountCode}, 
			#{subAccountFlow}, 
			#{totalAccountGroup}, 
			#{subAccountTable}, 
			#{subAccountSum}, 
			NOW(), 
			#{subAccountDetail}, 
			#{subjectCode}, 
			#{subCode}, 
			#{subStaffCode})
	</insert>
	<!-- 리스트조회 권한 체크 -->
	<select id="subAccountKeeperCheck"
		parameterType="com.cafe24.seoje1004.subStaff.model.SubStaff"
		resultMap="subAccountResultMap">
		SELECT 
			sub_staff_code as subStaffKeeper,
			sub_code as subCode
		FROM
			sub_staff
		WHERE
			sub_staff_code = #{subStaffCode} AND sub_Staff_pw = #{subStaffPw} AND sub_staff_level = '점주' AND sub_code = #{subCode}
	</select>
	<!-- 점주가 회계 마감 -->
	<update id="modifySubAccountCheck"
		parameterType="com.cafe24.seoje1004.subAccount.model.SubAccount">
		UPDATE sub_account
		SET
			sub_account_check = NOW(),
			sub_staff_keeper = #{subStaffKeeper}
		WHERE 
			sub_account_code = #{subAccountCode}
	</update>
	
	<!-- 통합회계리스트 출력 -->
	<select id="viewSubAccountList"
		parameterType="java.util.Map"
		resultMap="subAccountResultMap">
		SELECT sub_account_code, sub_account_flow, total_account_group, sub_account_table, sub_account_sum, sub_account_request_date, sub_account_check, sub_account_detail, subject_code, sub_client_code, sub_code, sub_staff_code, sub_staff_keeper
		FROM sub_account
		WHERE sub_code = #{subStaffSearch.subCode}
	
	</select>
</mapper>